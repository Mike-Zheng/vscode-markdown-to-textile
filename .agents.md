# Agent Instructions for Markdown to Textile Converter

## Project Overview

This is a Visual Studio Code extension that converts Markdown syntax to Textile markup format, specifically optimized for Redmine. The extension uses an Abstract Syntax Tree (AST) based parser for accurate conversion.

**Key Features:**
- In-place text conversion via command palette or context menu
- AST-based parsing for accurate transformation
- Supports all common Markdown elements (headings, lists, tables, code blocks, formatting, etc.)
- Special handling for Redmine-specific Textile syntax (CodeRay for code blocks)
- Comprehensive test suite with 33+ unit tests

## Project Structure

```
vscode-markdown-to-textile/
├── src/
│   ├── extension.ts           # VS Code extension entry point
│   ├── markdown-ast.ts         # Markdown parser (AST generation)
│   ├── textile-generator.ts    # Textile output generator
│   └── test/
│       └── extension.test.ts   # Unit tests (33 tests)
├── img/                        # Extension icons and assets
├── dist/                       # Compiled output (webpack)
├── package.json                # Extension manifest and dependencies
├── webpack.config.js           # Webpack bundling configuration
├── tsconfig.json              # TypeScript configuration
├── eslint.config.mjs          # ESLint configuration
└── view-ast.ts                # CLI tool for AST debugging
```

## Core Architecture

### 1. Extension Entry Point (`extension.ts`)

- **Activation:** Registers command `markdown-to-textile.convertToTextile`
- **Workflow:**
  1. Get active editor and selected text
  2. Parse Markdown to AST using `MarkdownParser`
  3. Generate Textile from AST using `TextileGenerator`
  4. Replace selection with converted text
  5. Show success/error notification

### 2. Markdown Parser (`markdown-ast.ts`)

**AST Node Types:**
- Block-level: `document`, `heading`, `paragraph`, `list`, `listItem`, `blockquote`, `codeBlock`, `table`, `tableRow`, `tableCell`, `horizontalRule`
- Inline-level: `text`, `bold`, `italic`, `code`, `link`, `image`, `lineBreak`

**Parser Strategy:**
- Top-down recursive descent parser
- Block parsing first, then inline parsing
- Maintains position pointer (`pos`) through input string
- Handles nested structures (nested lists, formatted text in tables)

**Key Methods:**
- `parse()` - Entry point, returns document AST
- `parseBlock()` - Identifies and parses block-level elements
- `parseInline()` - Parses inline formatting within blocks
- `parseList()` - Handles nested lists with depth tracking
- `parseTable()` - Detects and parses Markdown tables with alignment

### 3. Textile Generator (`textile-generator.ts`)

**Conversion Rules:**
- Headings: `# H1` → `h1. H1`
- Bold: `**text**` → `*text*` (with smart spacing)
- Italic: `*text*` → `_text_` (with smart spacing)
- Code: `` `code` `` → `%{...}code%` (with CSS styling) or `@code@` (inside tables)
- Links: `[text](url)` → `"text":url`
- Images: `![alt](url)` → `!url(alt)!`
- Lists: `-`, `*` → `*` (unordered), `1.` → `#` (ordered)
- Code blocks: ` ```lang` → `<pre><code class="lang">...</code></pre>`
- Tables: Pipe-delimited with `_.` for headers and alignment markers

**Smart Spacing:**
The generator automatically adds spaces around Textile formatting markers (`*`, `_`) when adjacent to text without spaces, ensuring proper rendering. For example:
- `AB**C**.` → `AB* C*.` (space added before C)
- `test**bold**text` → `test* bold *text` (spaces added on both sides)

## Development Guidelines

### Code Style

- **Language:** TypeScript with strict mode
- **Indentation:** Tabs (as per project configuration)
- **Line Length:** No strict limit, but keep readable
- **Naming Conventions:**
  - Classes: PascalCase (`MarkdownParser`)
  - Methods/Functions: camelCase (`parseBlock`)
  - Private members: prefix with underscore (`private _input`)
- **Error Handling:** Try-catch blocks with user-friendly error messages via vscode.window.showErrorMessage

### VS Code Extension Patterns

- Use `vscode.window.activeTextEditor` for editor access
- Use `editor.edit()` for text modifications
- Use `vscode.window.show*Message()` for user notifications
- Register commands in `activate()`, dispose in `deactivate()`
- Follow VS Code extension best practices (see package.json contributes section)

### Testing

**Test Suite Organization:**
1. Basic Text Formatting (4 tests)
2. Headings (4 tests)
3. Links and Images (4 tests)
4. Inline Code (3 tests)
5. Code Blocks (3 tests)
6. Lists (3 tests)
7. Tables (3 tests)
8. Blockquotes (3 tests)
9. Complex Content & Edge Cases (6 tests)

**Running Tests:**
```bash
pnpm test              # Run all tests (compile + lint + test)
pnpm run compile-tests # Compile tests only
pnpm run lint          # Run ESLint
```

**Test Patterns:**
- Use `assert.strictEqual()` for exact matches
- Use `assert.ok(result.includes(...))` for partial matches
- Test edge cases (empty strings, whitespace, special characters)
- Test Chinese/international content

## Common Tasks

### Adding Support for New Markdown Syntax

1. **Add node type** to `NodeType` union in `markdown-ast.ts`
2. **Extend `ASTNode` interface** if new properties needed
3. **Add parsing logic** in `MarkdownParser`:
   - Add detection in `parseBlock()` or `parseInline()`
   - Implement `parse[ElementName]()` method
4. **Add generation logic** in `TextileGenerator`:
   - Add case in `generateBlock()` or `generateInlineNode()`
   - Implement `generate[ElementName]()` method
5. **Add tests** in `extension.test.ts` with various scenarios
6. **Update README.md** with syntax conversion example

### Debugging AST Issues

Use the included AST viewer tool:
```bash
npx ts-node view-ast.ts <markdown-file.md>
```

This generates:
- `<file>-ast.json` - Full AST structure
- `<file>-output.textile` - Converted Textile
- `<file>-summary.txt` - Statistics and analysis

### Building and Packaging

```bash
pnpm run compile        # Development build (with source maps)
pnpm run watch          # Auto-rebuild on changes
pnpm run package        # Production build (minified)
pnpm run vscode:prepublish  # Prepare for publishing
```

### Common Pitfalls

1. **Spacing Issues:** Textile requires spaces around formatting markers. Use `generateFormattedText()` helper for automatic spacing.
2. **Table Context:** Inline code behaves differently in tables (`@code@`) vs paragraphs (`%{...}code%`). Always pass `inTable` parameter.
3. **Nested Lists:** Track depth correctly and use recursive calls to `generateList(node, depth + 1)`.
4. **Special Characters:** Escape `%` as `&#37;` in inline code to avoid Textile interpretation.
5. **Parser State:** Always reset `pos` when creating new parser instances for nested content.

## API Reference

### MarkdownParser

```typescript
class MarkdownParser {
  parse(markdown: string): ASTNode
  // Parses Markdown string into AST
}
```

### TextileGenerator

```typescript
class TextileGenerator {
  generate(ast: ASTNode): string
  // Generates Textile string from AST
}
```

### ASTNode Interface

```typescript
interface ASTNode {
  type: NodeType
  children?: ASTNode[]
  value?: string        // Text content
  level?: number        // Heading level (1-6)
  url?: string          // Link/image URL
  alt?: string          // Image alt text
  ordered?: boolean     // List type
  language?: string     // Code block language
  isHeader?: boolean    // Table header cell
  align?: 'left' | 'center' | 'right'  // Table cell alignment
  depth?: number        // List nesting depth
}
```

## Performance Considerations

- AST parsing is O(n) where n = input length
- No regex backtracking vulnerabilities
- Minimal memory allocations (string concatenation optimized)
- Tests run in < 1 second for typical workloads

## Contributing

When making changes:
1. Always add tests for new features or bug fixes
2. Run `pnpm test` before committing
3. Update README.md if user-facing changes
4. Follow existing code style (run `pnpm run lint`)
5. Test in VS Code Extension Development Host (F5)

## Resources

- [VS Code Extension API](https://code.visualstudio.com/api)
- [Textile Markup Reference](https://textile-lang.com/)
- [Redmine Textile Guide](https://www.redmine.org/projects/redmine/wiki/RedmineTextFormattingTextile)
- [Markdown Spec (CommonMark)](https://commonmark.org/)

## License

This project follows the license specified in LICENSE file.
